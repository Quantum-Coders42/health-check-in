name: Smart Build, Push and Deploy

on:
  push:
    branches: [ main ]

env:
  REGISTRY: crpi-9koetp78bl09eg2k.cn-shenzhen.personal.cr.aliyuncs.com
  IMAGE_NAME: ${{ secrets.ALIYUN_ACR_NAMESPACE }}/health-check-in  # é˜¿é‡Œäº‘é•œåƒåç§°
  CONTAINER_NAME: health-check-in  # å®¹å™¨åç§°
  NETWORK_NAME: jade-network  # ç½‘ç»œåç§°
  HOST_PORT: 8080  # ä¸»æœºç«¯å£
  CONTAINER_PORT: 8080  # å®¹å™¨ç«¯å£

jobs:
  smart-build-deploy:
    runs-on: ubuntu-latest

    steps:
      # æ£€å‡ºä»£ç 
      - name: Checkout
        uses: actions/checkout@v4

      # è®¾ç½® JDK 17
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      # ç™»å½•é˜¿é‡Œäº‘å®¹å™¨é•œåƒæœåŠ¡
      - name: Login to Aliyun ACR
        uses: docker/login-action@v2
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.ALIYUN_ACR_USERNAME }}
          password: ${{ secrets.ALIYUN_ACR_PASSWORD }}

      # æ£€æŸ¥é•œåƒæ˜¯å¦å·²å­˜åœ¨
      - name: Check if image exists
        id: check-image
        run: |
          COMMIT_SHA=${{ github.sha }}
          IMAGE_URL="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${COMMIT_SHA}"
          echo "Checking if image exists: ${IMAGE_URL}"
          
          # å°è¯•æ‹‰å–é•œåƒï¼Œå¦‚æžœæˆåŠŸè¯´æ˜Žå·²å­˜åœ¨
          if docker pull ${IMAGE_URL} 2>/dev/null; then
            echo "Image already exists, skipping build"
            echo "image-exists=true" >> $GITHUB_OUTPUT
          else
            echo "Image does not exist, will build and push"
            echo "image-exists=false" >> $GITHUB_OUTPUT
          fi

      # æž„å»ºå¹¶æŽ¨é€é•œåƒï¼ˆä»…å½“é•œåƒä¸å­˜åœ¨æ—¶ï¼‰
      - name: Build and push
        if: steps.check-image.outputs.image-exists == 'false'
        uses: docker/build-push-action@v4
        with:
          context: .  # Dockerfile åœ¨æ ¹ç›®å½•
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          push: true

      # é…ç½® SSH çŽ¯å¢ƒ
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.PUBLIC_SERVER_PRIVATE_KEY }}" > ~/.ssh/server.pem
          chmod 600 ~/.ssh/server.pem
          ssh-keyscan ${{ secrets.PUBLIC_SERVER_HOST }} >> ~/.ssh/known_hosts

      # SSH ç›´æŽ¥è¿žæŽ¥åˆ°å…¬ç½‘æœåŠ¡å™¨éƒ¨ç½²
      - name: Deploy via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.PUBLIC_SERVER_HOST }}  # å…¬ç½‘æœåŠ¡å™¨IPæˆ–åŸŸå
          username: ${{ secrets.PUBLIC_SERVER_USERNAME }}  # ç™»å½•ç”¨æˆ·å
          key: ${{ secrets.PUBLIC_SERVER_PRIVATE_KEY }}  # SSHç§é’¥
          script: |
            set -e  # é‡åˆ°é”™è¯¯ç«‹å³é€€å‡º
            
            echo "Starting smart deployment with commit: ${{ github.sha }}"
            
            # å®šä¹‰å˜é‡
            IMAGE_URL="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}"
            BACKUP_SCRIPT="/opt/health-check-in/scripts/backup-container.sh"
            VALIDATE_SCRIPT="/opt/health-check-in/scripts/validate-deployment.sh"
            
            # åˆ›å»ºè„šæœ¬ç›®å½•
            mkdir -p /opt/health-check-in/scripts
            
            # åˆ›å»ºå¤‡ä»½è„šæœ¬ï¼ˆå¦‚æžœä¸å­˜åœ¨ï¼‰
            if [ ! -f "${BACKUP_SCRIPT}" ]; then
              echo "Creating backup script..."
              cat > "${BACKUP_SCRIPT}" << 'EOF'
            #!/bin/bash
            CONTAINER_NAME="health-check-in"
            BACKUP_DIR="/opt/backups/health-check-in"
            DATE=$(date +%Y%m%d_%H%M%S)
            mkdir -p ${BACKUP_DIR}
            if docker ps -a --format "table {{.Names}}" | grep -q "^${CONTAINER_NAME}$"; then
                docker inspect ${CONTAINER_NAME} > ${BACKUP_DIR}/container_config_${DATE}.json
                docker logs --tail 1000 ${CONTAINER_NAME} > ${BACKUP_DIR}/container_logs_${DATE}.log 2>&1
                echo "Container status: $(docker inspect -f '{{.State.Status}}' ${CONTAINER_NAME})" > ${BACKUP_DIR}/status_${DATE}.txt
                echo "Backup completed: ${DATE}"
            fi
            EOF
              chmod +x "${BACKUP_SCRIPT}"
            fi
            
            # åˆ›å»ºéªŒè¯è„šæœ¬ï¼ˆå¦‚æžœä¸å­˜åœ¨ï¼‰
            if [ ! -f "${VALIDATE_SCRIPT}" ]; then
              echo "Creating validation script..."
              cat > "${VALIDATE_SCRIPT}" << 'EOF'
            #!/bin/bash
            CONTAINER_NAME="health-check-in"
            MAX_RETRIES=30
            RETRY_COUNT=0
            if ! docker ps --format "table {{.Names}}" | grep -q "^${CONTAINER_NAME}$"; then
                echo "âŒ Container not running!"
                exit 1
            fi
            while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
                if docker ps -f name=${CONTAINER_NAME} --format "table {{.Status}}" | grep -q "Up"; then
                    echo "âœ… Container is healthy!"
                    exit 0
                fi
                RETRY_COUNT=$((RETRY_COUNT + 1))
                sleep 10
            done
            echo "âŒ Container health check failed!"
            exit 1
            EOF
              chmod +x "${VALIDATE_SCRIPT}"
            fi
            
            # å¤‡ä»½å½“å‰å®¹å™¨
            echo "Backing up current container..."
            ${BACKUP_SCRIPT} || echo "Backup completed with warnings"
            
            # ç™»å½•é˜¿é‡Œäº‘å®¹å™¨é•œåƒæœåŠ¡
            echo "Logging in to Aliyun ACR..."
            echo "${{ secrets.ALIYUN_ACR_PASSWORD }}" | docker login ${{ env.REGISTRY }} -u "${{ secrets.ALIYUN_ACR_USERNAME }}" --password-stdin
            
            # æ‹‰å–æŒ‡å®šç‰ˆæœ¬çš„é•œåƒ
            echo "Pulling image: ${IMAGE_URL}"
            docker pull ${IMAGE_URL}
            
            # åœæ­¢æ—§å®¹å™¨ï¼ˆå¦‚æžœå­˜åœ¨ï¼‰
            echo "Stopping old container..."
            docker stop ${{ env.CONTAINER_NAME }} 2>/dev/null || true
            docker rm ${{ env.CONTAINER_NAME }} 2>/dev/null || true
            
            # åˆ›å»ºç½‘ç»œï¼ˆå¦‚æžœä¸å­˜åœ¨ï¼‰
            echo "Creating network if not exists..."
            docker network create ${{ env.NETWORK_NAME }} 2>/dev/null || true
            
            # ä½¿ç”¨çº¯Dockerå‘½ä»¤å¯åŠ¨æ–°å®¹å™¨
            echo "Starting new container with image: ${IMAGE_URL}"
            docker run -d \
              --name ${{ env.CONTAINER_NAME }} \
              --network ${{ env.NETWORK_NAME }} \
              --restart unless-stopped \
              -p ${{ env.HOST_PORT }}:${{ env.CONTAINER_PORT }} \
              -e APP_SPRING_DATASOURCE_USERNAME=root \
              -e APP_SPRING_DATASOURCE_PASSWORD=mysql_bzzTct \
              -e APP_SPRING_DATASOURCE_URL=106.55.7.149:3306 \
              -e APP_JWT_SECRET=1c4b7624085444ad6b2d147df9db9f6e \
              ${IMAGE_URL}
            
            # éªŒè¯éƒ¨ç½²
            echo "Validating deployment..."
            if ${VALIDATE_SCRIPT}; then
                echo "âœ… Deployment validation passed!"
            else
                echo "âŒ Deployment validation failed!"
                echo "Container logs (last 50 lines):"
                docker logs --tail 50 ${{ env.CONTAINER_NAME }}
                exit 1
            fi
            
            # æ¸…ç†æ—§é•œåƒï¼ˆä¿ç•™æœ€è¿‘3ä¸ªç‰ˆæœ¬ï¼‰
            echo "Cleaning up old images..."
            docker images "${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}" --format "table {{.Repository}}:{{.Tag}}\t{{.ID}}\t{{.CreatedAt}}" | \
              tail -n +4 | \
              awk 'NR>2 {print $2}' | \
              xargs -r docker rmi 2>/dev/null || true
            
            echo "ðŸŽ‰ Smart deployment completed successfully!"